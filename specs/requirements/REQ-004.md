# REQ-004: Four-Tier Document Classification for DSL Validation

**Version**: 1.0
**Created**: 2025-10-31
**Status**: Active

## Purpose

Enable flexible reference resolution in DSL validation by supporting documents that exist outside formal type definitions. This allows projects to maintain both formally typed specifications and informal documentation while still validating cross-references between them.

## Addresses

- [JOB-002](../jobs/JOB-002.md): Maintain Traceability Between Requirements and Tests

## Description

The DSL validation system shall support a four-tier classification system for documents and references:

1. **Excluded** - Files not scanned at all (via `.gitignore` and VCS auto-exclude)
2. **Typed** - Files matching type definitions (Job, ADR, Requirement, etc.) with full validation
3. **Unmanaged** - Files in scope but without strict validation (via `.specignore` or auto-classification) - existence check only
4. **External** - URLs outside the repository (public URLs checked, private URLs trusted)

### Default Behavior

By default (Option A), files that don't match any type definition are automatically treated as **Unmanaged**. This provides low friction for getting started and allows gradual adoption of formal type definitions.

### Strict Mode

When the `--strict` flag is enabled, files that don't match any type definition and are not explicitly listed in `.specignore` will generate warnings. This encourages explicit classification and clearer intent.

### Reference Resolution

References between documents are validated based on their classification:

- **Typed → Typed**: Full structural validation and type checking
- **Typed → Unmanaged**: Existence check only
- **Typed → External Public**: HTTP accessibility check
- **Typed → External Private**: Skipped (trusted)
- **Unmanaged → Typed**: Reference succeeds, target validated
- **Unmanaged → Unmanaged**: Existence check only
- **Unmanaged → External**: Same as typed documents

### VCS Directory Auto-Exclusion

The system shall automatically exclude version control system metadata directories:
- `.git/`, `.hg/`, `.svn/`, `.bzr/`

Build artifacts and dependencies (`.venv/`, `node_modules/`, `__pycache__/`, etc.) should be excluded via `.gitignore`, not auto-excluded.

Note: `.claude/` is NOT auto-excluded since users may want to validate it.

### .gitignore Support

Files matching `.gitignore` patterns are completely invisible to the validator (not scanned). This can be disabled with the `--no-gitignore` flag.

### .specignore Support

A new `.specignore` file uses gitignore-style glob patterns to mark files as "Unmanaged" type. Unlike `.gitignore`, these files are still scanned and can be referenced.

Example `.specignore`:
```
# AI assistant context files
.claude/**/*.md

# General documentation
docs/notes/**/*.md
roadmap/**/*.md

# Meeting notes
meetings/**/*.md
```

### External URL Configuration

External URLs are classified as public or private using `.speclinkconfig` (reused from the `check-links` command):

```
# Private URL patterns (won't be checked)
localhost
127.0.0.1
internal.company.com
```

## Acceptance Criteria

### AC-01: Auto-Exclude VCS Metadata Directories

**Given** a project with `.git/`, `.svn/`, `.venv/`, and `node_modules/` directories
**When** the validator scans for markdown files
**Then** it shall exclude `.git/` and `.svn/` directories automatically (VCS metadata)
**And** it shall NOT auto-exclude `.venv/` and `node_modules/` (should use .gitignore instead)
**And** it shall NOT exclude `.claude/` directory
**And** VCS metadata directories shall not appear in any validation results

### AC-02: Respect .gitignore by Default

**Given** a `.gitignore` file containing `build/**` pattern
**When** the validator scans for markdown files with default settings
**Then** it shall exclude all files matching `build/**` pattern
**And** excluded files shall not be scanned or registered
**And** references to excluded files shall fail validation

### AC-03: Support Disabling .gitignore

**Given** a `.gitignore` file containing `build/**` pattern
**When** the validator runs with `--no-gitignore` flag
**Then** it shall scan files matching `build/**` pattern
**And** it shall classify them according to type matching

### AC-04: Load .specignore Patterns

**Given** a `.specignore` file containing `docs/**/*.md` pattern
**When** the validator scans for markdown files
**Then** it shall load patterns from `.specignore`
**And** it shall mark files matching `docs/**/*.md` as Unmanaged
**And** unmanaged files shall be available for reference resolution

### AC-05: Type Precedence Over .specignore

**Given** a `.specignore` file containing `specs/**/*.md` pattern
**And** a file `specs/ADR-001.md` matching the ADR type definition
**When** the validator classifies documents
**Then** `specs/ADR-001.md` shall be classified as Typed (ADR)
**And** it shall receive full structural validation
**And** .specignore pattern shall be ignored for this file

### AC-06: Default Behavior (Option A)

**Given** a file that matches no type definition
**And** no `.specignore` file exists
**When** the validator classifies documents in default mode
**Then** the file shall be classified as Unmanaged
**And** no warning shall be generated
**And** the file shall be available for reference resolution

### AC-07: Strict Mode Behavior

**Given** a file that matches no type definition
**And** the file is not in `.specignore`
**When** the validator runs with `--strict` flag
**Then** the validator shall generate a warning
**And** the warning shall suggest adding to `.specignore` or creating a type definition
**And** the file shall still be available for reference resolution

### AC-08: Typed to Unmanaged Reference

**Given** a typed document `specs/ADR-001.md`
**And** an unmanaged document `docs/deployment.md`
**When** ADR-001 references `../../docs/deployment.md`
**Then** the validator shall resolve the reference
**And** it shall check that `docs/deployment.md` exists
**And** it shall not perform structural validation on deployment.md
**And** it shall not check type matching

### AC-09: Unmanaged to Typed Reference

**Given** an unmanaged document `docs/deployment.md`
**And** a typed document `specs/ADR-001.md`
**When** deployment.md references `../specs/ADR-001.md`
**Then** the validator shall resolve the reference
**And** it shall find ADR-001 in the ID registry
**And** the reference shall succeed

### AC-10: Typed to Typed Reference (Existing Behavior)

**Given** two typed documents `specs/ADR-001.md` and `specs/ADR-002.md`
**When** ADR-001 references ADR-002
**Then** the validator shall perform full structural validation
**And** it shall validate type matching according to reference definitions
**And** it shall validate cardinality constraints

### AC-11: External Public URL Validation

**Given** a document with reference `[Docs](https://docs.python.org/3/)`
**And** the URL does not match private patterns
**When** the validator resolves external references
**Then** it shall send an HTTP HEAD request to the URL
**And** it shall accept status codes 200-399 as valid
**And** it shall report 400+ status codes as errors

### AC-12: External Private URL Skipping

**Given** a document with reference `[Wiki](https://internal.company.com/wiki)`
**And** `.speclinkconfig` contains `internal.company.com` pattern
**When** the validator resolves external references
**Then** it shall identify the URL as private
**And** it shall skip the HTTP check
**And** it shall count it as a trusted reference

### AC-13: Missing Unmanaged File Error

**Given** a typed document referencing `./missing.md`
**And** the file does not exist
**When** the validator resolves references
**Then** it shall report an error
**And** the error shall indicate the file was not found
**And** validation shall fail

### AC-14: CLI Flag Support

**Given** the validate-dsl command
**When** invoked with configuration flags
**Then** it shall support `--strict` flag to enable strict mode
**And** it shall support `--use-gitignore` / `--no-gitignore` flags
**And** it shall support `--specignore <path>` to specify custom .specignore file
**And** it shall support `--no-specignore` to disable .specignore entirely
**And** it shall support `--check-external` / `--no-external` for external URL validation
**And** it shall support `--private-url-config <path>` for custom .speclinkconfig location

### AC-15: Validation Statistics

**Given** validation has completed
**When** the validator generates a report
**Then** it shall include count of documents scanned
**And** it shall break down documents by type (Typed, Unmanaged)
**And** it shall include count of excluded files
**And** it shall include reference validation statistics by type
**And** it shall include external URL check statistics

## Implementation Notes

### Data Structures

- Add `UnmanagedFile` dataclass in `validator.py`
- Add `unmanaged_files: dict[Path, UnmanagedFile]` to `DSLValidator`
- Update `ReferenceResolver.__init__()` to accept unmanaged files and private URL patterns

### File Classification Flow

1. Find all markdown files with `root_path.rglob("*.md")`
2. Filter out VCS directories (auto-exclude)
3. Filter out .gitignore patterns (if enabled)
4. For each remaining file:
   - Try to match against type definitions → **Typed**
   - Check if matches .specignore patterns → **Unmanaged**
   - No match with --strict → **Warning + Unmanaged**
   - No match without --strict → **Unmanaged**

### Reference Resolution Flow

1. External reference (starts with `http://`, `https://`):
   - Check private URL patterns → External Private (skip)
   - Otherwise → External Public (HTTP check)
2. Module/Class reference:
   - Try typed resolution (ID registry lookup)
   - Try file path resolution (typed)
   - Fall back to unmanaged file resolution
   - Error if not found in any registry

## Testing Requirements

- Unit tests for VCS directory detection
- Unit tests for .gitignore pattern loading and matching
- Unit tests for .specignore pattern loading and matching
- Unit tests for file classification with type precedence
- Unit tests for default mode (Option A) behavior
- Unit tests for strict mode (Option B) behavior
- Integration tests for all reference type combinations
- Integration tests for external URL validation
- CLI tests for all command-line flags
- Edge case tests (circular references, symlinks, etc.)

## Migration Path

Existing projects using validate-dsl will continue to work with default behavior:
- VCS directories automatically excluded (safety improvement)
- .gitignore respected by default (safety improvement)
- Files without type definitions now resolve instead of failing (improvement)

Projects wanting stricter validation can:
1. Enable `--strict` flag to get warnings for unclassified files
2. Create `.specignore` to explicitly mark informal documentation
3. Gradually add type definitions to move files from Unmanaged to Typed

## Jobs Addressed

This requirement indirectly supports the following Jobs-to-be-Done by improving the DSL validation system:

- **[JOB-002](../jobs/JOB-002.md): Maintain Traceability Between Requirements and Tests** - By enabling flexible reference resolution, this requirement allows projects to maintain documentation in both formal and informal formats while still validating cross-references and maintaining traceability between different document types.

## Related Issues

- Issue #42: validate-dsl Reference Resolution Failures
- PR #34: Auto-ignore VCS directories in linter
- PR #37: Support file path references in validate-dsl
